name: Autofix (push to main)

on:
  workflow_dispatch: {}
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  autofix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------- JS / TS ----------
      - name: Setup Node
        if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Node dependencies
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          npm ci || npm install

      - name: ESLint (JavaScript only)
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          echo "Running ESLint..."
          npx eslint . --ext .js,.mjs --fix || {
            echo "ESLint found issues that couldn't be fixed"
            npx eslint . --ext .js,.mjs || true
          }

      - name: Prettier
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          echo "Running Prettier..."
          npx prettier . --write --log-level=error || {
            echo "Prettier encountered errors"
            exit 0
          }

      # ---------- Python ----------
      - name: Setup Python
        if: ${{ hashFiles('**/*.py') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tools
        if: ${{ hashFiles('**/*.py') != '' }}
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort

      - name: Ruff
        if: ${{ hashFiles('**/*.py') != '' }}
        run: |
          echo "Running Ruff..."
          ruff check . --fix --unsafe-fixes || {
            echo "Ruff found issues that couldn't be fixed"
            ruff check . || true
          }

      - name: isort
        if: ${{ hashFiles('**/*.py') != '' }}
        run: |
          echo "Running isort..."
          isort . || {
            echo "isort encountered errors"
            exit 0
          }

      - name: Black
        if: ${{ hashFiles('**/*.py') != '' }}
        run: |
          echo "Running Black..."
          black . || {
            echo "Black encountered errors"
            exit 0
          }

      # ---------- Commit fixes directly to main (never commit workflow files) ----------
      - name: Commit & push to main
        run: |
          set -e
          git add -A
          # don't try to commit workflow files (GitHub blocks this)
          git restore --staged .github/workflows || true
          # nothing to commit? exit cleanly
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit - code is already formatted!"
            exit 0
          fi
          # show what we're about to commit
          echo "üìù Changes to commit:"
          git diff --cached --stat
          # make sure we can push fast-forward
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main || {
            echo "‚ùå Rebase failed - manual intervention required"
            exit 1
          }
          git commit -m "chore: autofix (ESLint/Prettier, Ruff/Black/isort)"
          git push origin HEAD:main
          echo "‚úÖ Code formatting fixes applied successfully!"
